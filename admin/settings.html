<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Settings</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
:root {
  --primary-color: #0d6efd;
  --secondary-color: #212529;
}
body { display:flex; min-height:100vh; overflow:auto; }
.sidebar { min-width:220px; background: var(--secondary-color); color:white; }
.sidebar a { display:flex; align-items:center; color:white; padding:12px; text-decoration:none; border-radius:5px; margin-bottom:5px; }
.sidebar a:hover { background:#495057; }
.sidebar a i { margin-right:10px; }
.sidebar h4 { color:#f8f9fa; margin-bottom:20px; }
.main-content { flex:1; padding:20px; background:#f8f9fa; overflow-y:auto; }
.card { min-height:120px; }
.btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
.btn-secondary { background-color: var(--secondary-color); border-color: var(--secondary-color); }
.nav-tabs .nav-link.active { background-color: var(--primary-color); color: white; }
</style>
</head>
<body class="bg-light">

<!-- Sidebar -->
<div class="sidebar p-3">
  <h4><i class="fas fa-cogs"></i> Admin Panel</h4><hr>
  <a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
  <a href="bookings.html"><i class="fas fa-calendar-check"></i> Bookings</a>
  <a href="tour-packages.html"><i class="fas fa-suitcase-rolling"></i> Tour Packages</a>
  <a href="prices-upgrade.html"><i class="fas fa-tags"></i> Prices Upgrade</a>
  <a href="homepage-slider.html"><i class="fas fa-images"></i> Homepage Slider</a>
  <a href="users.html"><i class="fas fa-users"></i> Users</a>
  <a href="contacts.html"><i class="fas fa-envelope"></i> Contact Messages</a>
  <a href="newsletter.html"><i class="fas fa-paper-plane"></i> NewsLetter</a>
  <a href="offers.html"><i class="fas fa-gift"></i> Offers</a>
  <a href="settings.html" class="active-page"><i class="fas fa-cog"></i> Settings</a>
  <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
</div>

<!-- Main Content -->
<div class="container py-4" id="contentArea">
  <h2><i class="fas fa-cogs"></i> Settings</h2>

  <!-- Site Info -->
  <form id="siteSettings" class="card p-3 shadow-sm mb-4">
    <h5>Site Information</h5>
    <input type="text" id="siteName" class="form-control mb-2" placeholder="Site Name">
    <textarea id="siteDesc" class="form-control mb-2" placeholder="Description"></textarea>
    <button class="btn btn-primary">Save Site Info</button>
  </form>

  <!-- Theme -->
  <form id="themeForm" class="card p-3 shadow-sm mb-4">
    <h5>Theme Colors</h5>
    <div class="mb-2">
      <label>Primary Color</label>
      <input type="color" id="primaryColor" class="form-control" value="#0d6efd">
    </div>
    <div class="mb-2">
      <label>Secondary Color</label>
      <input type="color" id="secondaryColor" class="form-control" value="#212529">
    </div>
    <button class="btn btn-primary">Save Theme</button>
    <div id="themeAlert" class="mt-2 text-success"></div>
  </form>

  <!-- Password -->
  <form id="passwordForm" class="card p-3 shadow-sm">
    <h5>Change Password</h5>
    <div class="mb-2">
      <label>Select User</label>
      <select id="selectUser" class="form-control"></select>
    </div>
    <div class="mb-2" id="showAdminPasswordDiv" style="display:none;">
      <label>Admin Current Password (enter passkey to show)</label>
      <div class="input-group">
        <input type="password" id="adminPassword" class="form-control" readonly>
        <button type="button" id="revealAdminPass" class="btn btn-secondary">Enter Passkey</button>
      </div>
    </div>
    <input type="password" id="newPassword" class="form-control mb-2" placeholder="New Password">
    <button class="btn btn-danger">Update Password</button>
  </form>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBz253Eiif34B28FdWiX51UmlbUF3dc-E0",
  authDomain: "ceybreeze-tours-3443d.firebaseapp.com",
  projectId: "ceybreeze-tours-3443d",
  storageBucket: "ceybreeze-tours-3443d.appspot.com",
  messagingSenderId: "94148437936",
  appId: "1:94148437936:web:4de667cfc522c502c05875"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Apply theme colors
function applyTheme(primary, secondary) {
  document.documentElement.style.setProperty('--primary-color', primary);
  document.documentElement.style.setProperty('--secondary-color', secondary);
}

async function initSettingsPage() {
  const user = JSON.parse(localStorage.getItem("loggedInUser"));
  if (!user) { window.location.href = "login.html"; return; }

  // Site Settings
  const siteForm = document.getElementById("siteSettings");
  if(user.role !== "admin") siteForm.style.display = "none";
  siteForm.addEventListener("submit", async e=>{
    e.preventDefault();
    await db.collection("settings").doc("site").set({
      name: document.getElementById("siteName").value,
      desc: document.getElementById("siteDesc").value
    });
    alert("Site info updated!");
  });
  const siteDoc = await db.collection("settings").doc("site").get();
  if(siteDoc.exists){
    document.getElementById("siteName").value = siteDoc.data().name || "";
    document.getElementById("siteDesc").value = siteDoc.data().desc || "";
  }

  // Theme Settings
  const themeForm = document.getElementById("themeForm");
  const themeAlert = document.getElementById("themeAlert");
  const primaryInput = document.getElementById("primaryColor");
  const secondaryInput = document.getElementById("secondaryColor");

  const themeDoc = await db.collection("settings").doc("theme").get();
  if(themeDoc.exists){
    const {primary, secondary} = themeDoc.data();
    primaryInput.value = primary || "#0d6efd";
    secondaryInput.value = secondary || "#212529";
    applyTheme(primaryInput.value, secondaryInput.value);
  }

  themeForm.addEventListener("submit", async e=>{
    e.preventDefault();
    const primary = primaryInput.value;
    const secondary = secondaryInput.value;
    await db.collection("settings").doc("theme").set({primary, secondary});
    themeAlert.innerHTML=`<div class="alert alert-success mt-2">Theme saved!</div>`;
    applyTheme(primary, secondary);
  });

  // Password
  const passwordForm = document.getElementById("passwordForm");
  const selectUser = document.getElementById("selectUser");
  const showAdminDiv = document.getElementById("showAdminPasswordDiv");
  const adminPassInput = document.getElementById("adminPassword");
  const revealBtn = document.getElementById("revealAdminPass");

  if(user.role==="admin"){
    selectUser.innerHTML=`<option value="admin">admin</option><option value="editor">editor</option>`;
    showAdminDiv.style.display="block";
  } else {
    selectUser.innerHTML=`<option value="${user.username}">${user.username}</option>`;
    selectUser.disabled=true;
    showAdminDiv.style.display="none";
  }

  revealBtn.addEventListener("click", async ()=>{
    const passkey = prompt("Enter passkey to reveal admin password:");
    if(passkey==="1234"){
      const adminDoc = await db.collection("users").doc("admin").get();
      adminPassInput.type="text";
      adminPassInput.value = adminDoc.data().password || "";
    } else { alert("Incorrect passkey!"); }
  });

  passwordForm.addEventListener("submit", async e=>{
    e.preventDefault();
    const targetUser = selectUser.value;
    const newPass = document.getElementById("newPassword").value.trim();
    if(!newPass) return alert("Enter a password!");
    try{
      await db.collection("users").doc(targetUser).update({password:newPass});
      alert("Password updated!");
      document.getElementById("newPassword").value="";
      if(targetUser==="admin") adminPassInput.value=newPass;
    }catch(err){
      alert("Failed: "+err.message);
    }
  });
}

// Logout
document.getElementById("logoutBtn").addEventListener("click", function(e){
  e.preventDefault();
  if(confirm("Are you sure you want to log out?")){
    localStorage.removeItem("loggedInUser");
    window.location.href="adminlogin.html";
  }
});

initSettingsPage();
</script>
</body>
</html>
