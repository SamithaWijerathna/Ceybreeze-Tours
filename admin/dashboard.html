<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
body { display:flex; min-height:100vh; overflow:auto; }
.sidebar { min-width:220px; background:#212529; color:white; }
.sidebar a { display:flex; align-items:center; color:white; padding:12px; text-decoration:none; border-radius:5px; margin-bottom:5px; }
.sidebar a:hover { background:#495057; }
.sidebar a i { margin-right:10px; }
.sidebar h4 { color:#f8f9fa; margin-bottom:20px; }
.main-content { flex:1; padding:20px; background:#f8f9fa; overflow-y:auto; }
.card { min-height:120px; }
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar p-3">
  <h4><i class="fas fa-cogs"></i> Admin Panel</h4><hr>
  <a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
  <a href="bookings.html"><i class="fas fa-calendar-check"></i> Bookings</a>
  <a href="tour-packages.html"><i class="fas fa-suitcase-rolling"></i> Tour Packages</a>
  <a href="prices-upgrade.html"><i class="fas fa-tags"></i> Prices Upgrade</a>
  <a href="homepage-slider.html"><i class="fas fa-images"></i> Homepage Slider</a>
  <a href="users.html"><i class="fas fa-users"></i> Users</a>
  <a href="contacts.html"><i class="fas fa-envelope"></i> Contact Messages</a>
  <a href="newsletter.html"><i class="fas fa-paper-plane"></i> NewsLetter</a>
  <a href="offers.html" class="active-page"><i class="fas fa-gift"></i> Offers</a>
  <a href="settings.html"><i class="fas fa-cog"></i> Settings</a>
  <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
</div>

<!-- Main Content -->
<div class="main-content">
  <h2>Welcome, Admin</h2>
  <p class="text-muted">Here is an overview of your travel site activity.</p>

  <!-- Summary Cards -->
  <div class="row">
    <div class="col-md-3 mb-3">
      <div class="card shadow-sm text-center p-3">
        <h5>Pending Bookings</h5>
        <p id="pendingBookingCount" class="fs-4">Loading...</p>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card shadow-sm text-center p-3">
        <h5>Confirmed Bookings</h5>
        <p id="confirmedBookingCount" class="fs-4">Loading...</p>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card shadow-sm text-center p-3">
        <h5>Completed</h5>
        <p id="completedBookingCount" class="fs-4">Loading...</p>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card shadow-sm text-center p-3">
        <h5>Total Users</h5>
        <p id="totalUsersCount" class="fs-4">Loading...</p>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="row mt-4">
    <div class="col-md-6 mb-4">
      <div class="card shadow-sm p-3">
        <h5><i class="fas fa-chart-bar"></i> Daily Bookings</h5>
        <canvas id="dailyBookingsChart"></canvas>
      </div>
    </div>
    <div class="col-md-6 mb-4">
      <div class="card shadow-sm p-3">
        <h5><i class="fas fa-user-plus"></i> Daily Registered Users</h5>
        <canvas id="dailyUsersChart"></canvas>
      </div>
    </div>
    <div class="col-md-6 mb-4">
      <div class="card shadow-sm p-3">
        <h5><i class="fas fa-chart-pie"></i> Booking Status Distribution</h5>
        <canvas id="bookingStatusChart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBz253Eiif34B28FdWiX51UmlbUF3dc-E0",
  authDomain: "ceybreeze-tours-3443d.firebaseapp.com",
  projectId: "ceybreeze-tours-3443d",
  storageBucket: "ceybreeze-tours-3443d.appspot.com",
  messagingSenderId: "94148437936",
  appId: "1:94148437936:web:4de667cfc522c502c05875",
  measurementId: "G-JB0916EC12"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// --- Load Counts ---
async function loadCounts() {
  const pending = await db.collection("bookings").get();
  const confirmed = await db.collection("confirmedbookings").get();
  const completed = await db.collection("completedbookings").get();
  const users = await db.collection("users").get();

  document.getElementById("pendingBookingCount").textContent = pending.size;
  document.getElementById("confirmedBookingCount").textContent = confirmed.size;
  document.getElementById("completedBookingCount").textContent = completed.size;
  document.getElementById("totalUsersCount").textContent = users.size;
}

// --- Charts ---
async function renderDailyBookingsChart() {
  const snapshot = await db.collection("bookings").get();
  const counts = {};
  snapshot.forEach(doc => {
    const date = doc.data().submittedAt?.toDate();
    if(!date) return;
    const day = date.toISOString().split('T')[0];
    counts[day] = (counts[day] || 0) + 1;
  });
  const labels = Object.keys(counts).sort();
  const data = Object.values(counts);
  new Chart(document.getElementById('dailyBookingsChart'), {
    type: 'bar',
    data: { labels, datasets:[{ label:'Bookings', data, backgroundColor:'rgba(54, 162, 235, 0.6)' }] }
  });
}

async function renderDailyUsersChart() {
  const snapshot = await db.collection("users").get();
  const counts = {};
  snapshot.forEach(doc => {
    const date = doc.data().registeredAt?.toDate();
    if(!date) return;
    const day = date.toISOString().split('T')[0];
    counts[day] = (counts[day] || 0) + 1;
  });
  const labels = Object.keys(counts).sort();
  const data = Object.values(counts);
  new Chart(document.getElementById('dailyUsersChart'), {
    type: 'line',
    data: { labels, datasets:[{ label:'New Users', data, borderColor:'rgba(75, 192, 192, 1)', fill:false }] }
  });
}

async function renderBookingStatusChart() {
  const pending = (await db.collection("bookings").get()).size;
  const confirmed = (await db.collection("confirmedbookings").get()).size;
  const completed = (await db.collection("completedbookings").get()).size;
  const cancelled = (await db.collection("cancelledbooking").get()).size;

  new Chart(document.getElementById('bookingStatusChart'), {
    type: 'pie',
    data: {
      labels:['Pending','Confirmed','Completed','Cancelled'],
      datasets:[{
        data:[pending,confirmed,completed,cancelled],
        backgroundColor:[
          'rgba(255, 206, 86, 0.7)',
          'rgba(54, 162, 235, 0.7)',
          'rgba(75, 192, 192, 0.7)',
          'rgba(255, 99, 132, 0.7)'
        ]
      }]
    }
  });
}

// Logout functionality
document.getElementById("logoutBtn").addEventListener("click", function(e) {
  e.preventDefault(); // prevent default link behavior
  if (confirm("Are you sure you want to log out?")) {
    localStorage.removeItem("loggedInUser"); // clear logged-in user
    window.location.href = "adminlogin.html"; // redirect to login page
  }
});

// Initialize
loadCounts();
renderDailyBookingsChart();
renderDailyUsersChart();
renderBookingStatusChart();
</script>

</body>
</html>
