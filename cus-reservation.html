<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Custom Tour Builder • CeyBreeze Tours</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
:root{--brand:#0d6efd;--soft:#f8f9fa;--card:#fff;--shadow:0 6px 20px rgba(0,0,0,.08);}
body{background:var(--soft)}
.container-xl{max-width:1200px}
.wizard-layout{display:grid;grid-template-columns:1.2fr .8fr;gap:24px}
@media(max-width:992px){.wizard-layout{grid-template-columns:1fr}}
.step{display:none}.step.active{display:block;animation:fadeIn .35s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
#progressbar{display:flex;gap:8px;list-style:none;padding:0;margin:0 0 16px 0;overflow-x:auto}
#progressbar li{flex:1;min-width:110px;text-align:center;font-size:.85rem;color:#7a7a7a}
#progressbar li .dot{width:34px;height:34px;border-radius:999px;display:grid;place-items:center;margin:0 auto 6px;background:#e9ecef}
#progressbar li.active{color:var(--brand);font-weight:600}#progressbar li.active .dot{background:rgba(13,110,253,.15)}
.card{border:0;border-radius:14px;box-shadow:var(--shadow)}
.card-header{background:transparent;border:0}
#summaryCol{position:sticky;top:16px;align-self:start}
#summaryCard{background:var(--card);border-radius:16px;box-shadow:var(--shadow)}
#summaryCard .price{font-size:1.25rem;font-weight:800;color:#0b3}
.line-item{display:flex;justify-content:space-between;font-variant-numeric:tabular-nums}
.line-item small{color:#6c757d}
.divider{border-top:1px dashed #d9d9d9;margin:.5rem 0}
.nav-buttons{display:flex;gap:10px;justify-content:space-between}
.place-card img{height:140px;object-fit:cover;border-top-left-radius:14px;border-top-right-radius:14px}
.pkg-chip{background:rgba(13,110,253,.1);color:var(--brand);padding:2px 8px;border-radius:10px;font-size:.75rem}
/* Selected Places Chips */
#selectedPlacesContainer .pkg-chip {
  background: #0d6efd1a; /* light blue background */
  color: #0d6efd;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 0.85rem;
  display: inline-flex;
  align-items: center;
  transition: background 0.2s, transform 0.2s;
}

#selectedPlacesContainer .pkg-chip:hover {
  background: #0d6efd33;
  transform: scale(1.05);
}

/* Remove "x" icon style */
#selectedPlacesContainer .pkg-chip i {
  font-size: 0.8rem;
  margin-left: 6px;
  color: #0d6efd;
  transition: color 0.2s;
}

#selectedPlacesContainer .pkg-chip i:hover {
  color: #dc3545; /* red on hover */
}

/* Selected Place Button Styling */
.place-card .select-place.selected {
  background-color: #0d6efd;
  color: #fff;
  border-color: #0d6efd;
}

</style>
</head>
<body>
<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container">
    <a class="navbar-brand" href="user-home.html">CeyBreeze Tours</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="user-home.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="bookings.html">My Bookings</a></li>
      </ul>
      <ul class="navbar-nav">
        <li class="nav-item"><span class="nav-link" id="navUserName">Welcome</span></li>
        <li class="nav-item"><a class="nav-link" href="logout.html">Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container-xl mb-5">
<h2 class="text-center mb-3">Custom Tour Builder</h2>
<ul id="progressbar" class="mb-3">
  <li class="active"><div class="dot"><i class="fa fa-map"></i></div>Select Places</li>
  <li><div class="dot"><i class="fa fa-calendar"></i></div>Travelers & Dates</li>
  <li><div class="dot"><i class="fa fa-hotel"></i></div>Hotel & Vehicle</li>
  <li><div class="dot"><i class="fa fa-utensils"></i></div>Meal Preference</li> <!-- NEW -->
  <li><div class="dot"><i class="fa fa-user"></i></div>Traveler Info</li>
  <li><div class="dot"><i class="fa fa-credit-card"></i></div>Payment & Confirm</li>
</ul>


<div class="wizard-layout">
<div>
<form id="customForm" class="needs-validation" novalidate>

<!-- Step 1: Select Places -->
<div class="step active" data-step="0">
<div class="card">
<div class="card-header"><h5>Select Places</h5></div>
<div class="card-body">
<input type="text" id="placeSearch" class="form-control mb-3" placeholder="Search places...">
<div id="placesGrid" class="row g-3"></div>
</div>

<div class="mt-3">
  <h6>Selected Places:</h6>
  <div id="selectedPlacesContainer" class="d-flex flex-wrap gap-2"></div>
</div>

<div class="card-footer nav-buttons">
<button type="button" class="btn btn-primary ms-auto nextBtn" disabled id="placesNext">Next</button>
</div>
</div>
</div>


<!-- Step 2: Travelers & Dates -->
<div class="step" data-step="1">
<div class="card">
<div class="card-header"><h5>Travelers & Dates</h5></div>
<div class="card-body">
<div class="row g-3">
<div class="col-md-4"><label>Adults</label><input type="number" id="adults" class="form-control" min="1" value="1"></div>
<div class="col-md-4"><label>Children</label><input type="number" id="children" class="form-control" min="0" value="0"></div>
<div class="col-md-4"><label>Infants</label><input type="number" id="infants" class="form-control" min="0" value="0"></div>
<div class="col-md-6"><label>Departure Date</label><input type="date" id="departureDate" class="form-control"></div>
<div class="col-md-6"><label>Total Days</label><input type="text" id="totalDays" class="form-control" readonly></div>
<div class="col-12 mt-2" id="daysBreakdown" style="background:#f1f1f1;padding:10px;border-radius:8px;font-size:0.9rem;"></div>
</div>
</div>
<div class="card-footer nav-buttons">
<button type="button" class="btn btn-outline-secondary prevBtn">Back</button>
<button type="button" class="btn btn-primary nextBtn">Next</button>
</div>
</div>
</div>

<!-- Step 3: Hotel & Vehicle -->
<div class="step" data-step="2">
<div class="card">
<div class="card-header"><h5>Hotel & Vehicle</h5></div>
<div class="card-body">
<div class="row g-3">
<div class="col-md-6"><label>Hotel Type</label><select id="hotelTypeSelect" class="form-select"></select></div>
<div class="col-md-6"><label>Vehicle Category</label><select id="vehicleCategorySelect" class="form-select"></select></div>
<div class="col-md-6"><label>Vehicle Type</label><select id="vehicleTypeSelect" class="form-select" disabled></select></div>
</div>
<div id="roomCountsContainer" class="row g-3 mt-3"></div>
</div>
<div class="card-footer nav-buttons">
<button type="button" class="btn btn-outline-secondary prevBtn">Back</button>
<button type="button" class="btn btn-primary nextBtn">Next</button>
</div>
</div>
</div>

<!-- Step 4: Meal Preference -->
<div class="step" data-step="3">
  <div class="card">
    <div class="card-header"><h5>Meal Preference</h5></div>
    <div class="card-body">
      <label>Meal Preference</label>
      <select id="mealPref" class="form-select">
        <option value="">Select</option>
        <option>Vegetarian</option>
        <option>Non-Vegetarian</option>
        <option>Halal</option>
        <option>Other</option>
      </select>
      <label class="mt-2">Special Requests</label>
      <textarea id="specialReq" class="form-control" rows="3"></textarea>
    </div>
    <div class="card-footer nav-buttons">
      <button type="button" class="btn btn-outline-secondary prevBtn">Back</button>
      <button type="button" class="btn btn-primary nextBtn">Next</button>
    </div>
  </div>
</div>


<!-- Step 4: Traveler Info -->
<div class="step" data-step="3">
<div class="card">
<div class="card-header"><h5>Traveler Info</h5></div>
<div class="card-body">
<div class="mb-3"><label>Full Name</label><input type="text" id="fullName" class="form-control" required></div>
<div class="mb-3"><label>Billing Address</label><input type="text" id="billingAddress" class="form-control"></div>
<input type="hidden" id="packageId" value="2">
<input type="hidden" id="packageName" value="Custom Package">
</div>
<div class="card-footer nav-buttons">
<button type="button" class="btn btn-outline-secondary prevBtn">Back</button>
<button type="button" class="btn btn-primary nextBtn">Next</button>
</div>
</div>
</div>



<!-- Step 5: Payment & Confirm -->
<div class="step" data-step="4">
<div class="card">
<div class="card-header"><h5>Payment & Confirm</h5></div>
<div class="card-body">
<label>Payment Method</label>
<select id="paymentMethod" class="form-select">
  <option value="">Select</option>
  <option>Credit Card</option>
  <option>Bank Transfer</option>
  <option>Cash</option>
</select>

</select>
<label class="mt-2">Special Requests</label>
<textarea id="specialReq" class="form-control" rows="3"></textarea>
<div id="reviewBlock" class="mt-3"></div>
</div>
<div class="card-footer nav-buttons">
<button type="button" class="btn btn-outline-secondary prevBtn">Back</button>
<button type="submit" class="btn btn-success">Confirm Booking</button>
</div>
</div>
</div>
</form>
</div>

<div id="summaryCol">
<div id="summaryCard" class="p-3">
<h5>Price Summary</h5>
<div id="summaryDays">0</div>
<div class="line-item"><span>Base</span><span id="lineBase">$0</span></div>
<div class="line-item"><span>Hotel</span><span id="lineHotel">$0</span></div>
<div class="line-item"><span>Rooms</span><span id="lineRooms">$0</span></div>
<div class="line-item"><span>Vehicle</span><span id="lineVehicle">$0</span></div>
<div class="divider"></div>
<div class="price" id="summaryTotal">$0</div>
</div>
</div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, getDoc, doc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

// Firebase config
const firebaseConfig = { 
  apiKey:"AIzaSyBz253Eiif34B28FdWiX51UmlbUF3dc-E0", 
  authDomain:"ceybreeze-tours-3443d.firebaseapp.com", 
  projectId:"ceybreeze-tours-3443d", 
  storageBucket:"ceybreeze-tours-3443d.appspot.com", 
  messagingSenderId:"94148437936", 
  appId:"1:94148437936:web:4de667cfc522c502c05875", 
  measurementId:"G-JB0916EC12" 
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Navbar user + auto-fill full name
onAuthStateChanged(auth, user=>{
  if(user){
    document.getElementById("navUserName").textContent = `Hi, ${user.displayName || user.email}`;
    document.getElementById("fullName").value = user.displayName || user.email;
  } else {
    window.location.href="login.html"; // force login if not logged in
  }
});


// Elements
const steps = document.querySelectorAll('.step'), 
      progressItems = document.querySelectorAll('#progressbar li'),
      placesGrid = document.getElementById('placesGrid'),
      totalDaysInput = document.getElementById('totalDays'),
      adultsEl = document.getElementById('adults'),
      childrenEl = document.getElementById('children'),
      infantsEl = document.getElementById('infants'),
      hotelTypeSelect = document.getElementById('hotelTypeSelect'),
      vehicleCategorySelect = document.getElementById('vehicleCategorySelect'),
      vehicleTypeSelect = document.getElementById('vehicleTypeSelect'),
      roomCountsContainer = document.getElementById('roomCountsContainer'),
      reviewBlock = document.getElementById('reviewBlock'),
      daysBreakdownEl = document.getElementById('daysBreakdown');
      

let currentStep = 0, priceData = null, vehiclePrices = null, places = [], selectedPlaces = [];

const fmt = n => new Intl.NumberFormat(undefined, {style:'currency', currency:'USD'}).format(+n||0);
const getTotalPeople = () => parseInt(adultsEl.value||0) + parseInt(childrenEl.value||0) + parseInt(infantsEl.value||0);

// DAYS CALCULATION
function getTotalDaysAndDetails() {
  if (!selectedPlaces.length) return {days:0, breakdown:''};
  const provinces = selectedPlaces.map(id => { const place = places.find(p=>p.id===id); return place ? place.province || 'Unknown' : 'Unknown'; });
  const provinceCounts = {};
  provinces.forEach(p => provinceCounts[p] = (provinceCounts[p] || 0) + 1);
  let days = 0, breakdown = '';
  Object.keys(provinceCounts).forEach(p=>{
    const count = provinceCounts[p];
    const provinceDays = Math.ceil(count/3);
    const extraTransit = (count % 3 === 0 && count>0)?1:0;
    days += provinceDays + (extraTransit?1:0);
    breakdown += `<div>${p}: ${count} place(s) → ${provinceDays} day(s)` + (extraTransit?' +1 transit day':'') + `</div>`;
  });
  days += 2; // departure & return
  breakdown += `<div>Departure & return: +2 days</div>`;
  return {days, breakdown};
}

// RECALC
function recalc() {
  const people = getTotalPeople();
  const {days, breakdown} = getTotalDaysAndDetails();
  totalDaysInput.value = days;
  daysBreakdownEl.innerHTML = breakdown;

  const baseCost = (priceData?.basePricePerPerson||0) * people * days;
  const hotelCost = (priceData?.hotelTypes?.[hotelTypeSelect.value]||0) * people * days;

  let roomsCost = 0;
  roomCountsContainer.querySelectorAll('input[data-room-type]').forEach(i=>{
    roomsCost += (priceData?.roomTypes?.[i.dataset.roomType]||0) * parseInt(i.value||0) * days;
  });

  const vCat = vehicleCategorySelect.value, vType = vehicleTypeSelect.value, vRate = (vehiclePrices?.[vCat]?.[vType]||0);
  const vehicleCost = vRate * days;
  const total = baseCost + hotelCost + roomsCost + vehicleCost;

  document.getElementById('lineBase').textContent = fmt(baseCost);
  document.getElementById('lineHotel').textContent = fmt(hotelCost);
  document.getElementById('lineRooms').textContent = fmt(roomsCost);
  document.getElementById('lineVehicle').textContent = fmt(vehicleCost);
  document.getElementById('summaryTotal').textContent = fmt(total);

  reviewBlock.innerHTML = `<div><strong>Days:</strong> ${days}<br><strong>Travelers:</strong> ${people}<br><strong>Price:</strong> ${fmt(total)}</div>`;
}

// NAVIGATION
function showStep(n){
  currentStep = n;
  steps.forEach((s,i)=>s.classList.toggle('active', i===n));
  progressItems.forEach((li,i)=>li.classList.toggle('active', i<=n));
  recalc();
}

document.addEventListener('click', e => {
  if(e.target.classList.contains('nextBtn')) { e.preventDefault(); showStep(Math.min(currentStep+1, steps.length-1)); }
  if(e.target.classList.contains('prevBtn')) { e.preventDefault(); showStep(Math.max(currentStep-1, 0)); }
});

// LOAD PLACES
async function loadPlaces() {
  places = []; 
  const snap = await getDocs(collection(db,'allplaces'));
  snap.forEach(d=>places.push({id:d.id, ...d.data()}));
  renderPlaces();
}

function renderPlaces() {
  placesGrid.innerHTML = '';
  places.forEach(p=>{
    const col = document.createElement('div'); col.className = 'col-md-6 col-lg-4';
    col.innerHTML = `<div class="card place-card h-100">
        <img src="${p.photo||''}" class="w-100">
        <div class="card-body">
            <h6>${p.name||p.title}</h6>
            <button type="button" class="btn btn-sm btn-outline-primary select-place" data-id="${p.id}">Select</button>
        </div>
    </div>`;
    placesGrid.appendChild(col);
  });
}

const selectedPlacesContainer = document.getElementById('selectedPlacesContainer');

function renderSelectedPlaces() {
  selectedPlacesContainer.innerHTML = '';
  selectedPlaces.forEach(id => {
    const place = places.find(p => p.id === id);
    if (!place) return;
    const chip = document.createElement('span');
    chip.className = 'pkg-chip';
    chip.textContent = place.name || place.title;
    
    // Add remove option
    const removeBtn = document.createElement('i');
    removeBtn.className = 'fa fa-times ms-1';
    removeBtn.style.cursor = 'pointer';
    removeBtn.addEventListener('click', () => {
      selectedPlaces = selectedPlaces.filter(x => x !== id);
      document.getElementById('placesNext').disabled = !selectedPlaces.length;
      renderSelectedPlaces();
      recalc();
    });

    chip.appendChild(removeBtn);
    selectedPlacesContainer.appendChild(chip);
  });
}

placesGrid.addEventListener('click', e => {
  const btn = e.target.closest('.select-place'); 
  if (!btn) return;
  const id = btn.dataset.id;

  if (selectedPlaces.includes(id)) {
    selectedPlaces = selectedPlaces.filter(x => x !== id);
    btn.classList.remove('selected'); // remove style
  } else {
    selectedPlaces.push(id);
    btn.classList.add('selected'); // add style
  }

  document.getElementById('placesNext').disabled = !selectedPlaces.length;
  renderSelectedPlaces();
  recalc();
});


// LOAD PRICES
async function loadPrices(){
  const docSnap = await getDoc(doc(db,'tourPrices','defaultPrices')); if(docSnap.exists()) priceData = docSnap.data();
  const vehSnap = await getDoc(doc(db,'vehiclePrices','defaultVehicles')); if(vehSnap.exists()) vehiclePrices = vehSnap.data();
  setupRoomInputs(); populateHotelTypes(); populateVehicleCategories();
}

function setupRoomInputs(){
  roomCountsContainer.innerHTML='';
  if(!priceData?.roomTypes) return;
  Object.keys(priceData.roomTypes).forEach(rt=>{
    const div=document.createElement('div'); 
    div.className='col-6 col-md-4 col-lg-3';
    div.innerHTML=`
        <label>${rt} Qty</label>
        <input type="number" min="0" value="0" data-room-type="${rt}" class="form-control room-input">
        <div class="form-text">${fmt(priceData.roomTypes[rt])}/night</div>
    `;
    roomCountsContainer.appendChild(div);
    div.querySelector('input').addEventListener('input', recalc);
  });
}

function populateHotelTypes(){
  hotelTypeSelect.innerHTML='<option value="">Select</option>';
  if(priceData?.hotelTypes) Object.keys(priceData.hotelTypes).forEach(ht=>{
    const opt = document.createElement('option'); opt.value = ht; opt.textContent = `${ht} (${fmt(priceData.hotelTypes[ht])}/person/day)`; hotelTypeSelect.appendChild(opt);
  });
}

function populateVehicleCategories(){
  vehicleCategorySelect.innerHTML='<option value="">Select</option>';
  if(vehiclePrices) Object.keys(vehiclePrices).forEach(cat=>{
    const opt=document.createElement('option'); opt.value=cat; opt.textContent=cat; vehicleCategorySelect.appendChild(opt);
  });
}

// Vehicle type load
vehicleCategorySelect.addEventListener('change',()=>{
  vehicleTypeSelect.innerHTML='<option value="">Select</option>'; vehicleTypeSelect.disabled=true;
  const cat=vehicleCategorySelect.value; if(!cat||!vehiclePrices?.[cat]) return;
  Object.keys(vehiclePrices[cat]).forEach(v=>{
    const opt=document.createElement('option'); opt.value=v; opt.textContent=`${v} (${fmt(vehiclePrices[cat][v])}/day)`; vehicleTypeSelect.appendChild(opt);
  }); vehicleTypeSelect.disabled=false; recalc();
});

// Event listeners
[adultsEl,childrenEl,infantsEl,hotelTypeSelect,vehicleCategorySelect,vehicleTypeSelect].forEach(el=>el.addEventListener('input', recalc));

// SUBMIT (modified)
document.getElementById('customForm').addEventListener('submit', async e=>{
  e.preventDefault();

  let roomCounts={}; roomCountsContainer.querySelectorAll('input[data-room-type]').forEach(i=>roomCounts[i.dataset.roomType]=parseInt(i.value||0));

  const base=parseFloat(document.getElementById('lineBase').textContent.replace(/[^0-9.]/g,''))||0;
  const hotel=parseFloat(document.getElementById('lineHotel').textContent.replace(/[^0-9.]/g,''))||0;
  const rooms=parseFloat(document.getElementById('lineRooms').textContent.replace(/[^0-9.]/g,''))||0;
  const vehicle=parseFloat(document.getElementById('lineVehicle').textContent.replace(/[^0-9.]/g,''))||0;
  const total=base+hotel+rooms+vehicle;
  const totalCostStr=new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'}).format(total);

  const depDate=document.getElementById('departureDate').value;
  const days=parseInt(totalDaysInput.value||0);
  let returnDate='';
  if(depDate&&days){const d=new Date(depDate); d.setDate(d.getDate()+days-1); returnDate=d.toISOString().split('T')[0];}

  // Selected places with names
  const selectedPlaceDetails=selectedPlaces.map(id=>{
    const p=places.find(pp=>pp.id===id);
    return {id, name:p?.name||p?.title||"Unknown"};
  });

  const bookingData={
    adults:parseInt(adultsEl.value||0),
    children:parseInt(childrenEl.value||0),
    infants:parseInt(infantsEl.value||0),
    departureDate:depDate,
    returnDate,
    fullName:document.getElementById('fullName').value,
    hotelType:hotelTypeSelect.value,
    vehicleCategory:vehicleCategorySelect.value,
    vehicleType:vehicleTypeSelect.value,
    mealPref:document.getElementById('mealPref').value,
    packageId:document.getElementById('packageId').value,
    packageName:document.getElementById('packageName').value,
    roomCounts,
    specialReq:document.getElementById('specialReq').value,
    selectedPlaces:selectedPlaceDetails,
    priceBreakdown:{base,hotel,rooms,vehicle,total},
    totalCost:totalCostStr,
    totalDays:days.toString(),
    payment:{method:document.getElementById('paymentMethod').value,billingAddress:document.getElementById('billingAddress').value},
    submittedAt:serverTimestamp()
  };

  await addDoc(collection(db,'bookings'), bookingData);
  alert('Booking saved!');
  window.location.href="userhome.html";
});


// INIT
await loadPlaces(); await loadPrices(); recalc();
</script>
</body>
</html>
